name: Test
on: [pull_request]

jobs:
  testing:
    name: Drupal ${{ matrix.drupal-core }} - PHP ${{ matrix.php-versions }}
    runs-on: ubuntu-latest
    services:
      mariadb:
        image: mariadb:10.9
        env:
          MYSQL_USER: drupal
          MYSQL_PASSWORD: drupal
          MYSQL_DATABASE: drupal
          MYSQL_ROOT_PASSWORD: drupal
        ports:
          - 3306:3306
    env:
      SIMPLETEST_DB: "mysql://drupal:drupal@mariadb:3306/drupal"
      SIMPLETEST_BASE_URL: "http://127.0.0.1:8080"
    strategy:
      fail-fast: false
      matrix:
        drupal-core: ['10.1.x', '10.2.x']
        php-versions: ['8.2']
    steps:
      - name: Checkout Drupal core
        uses: actions/checkout@v2
        with:
          repository: drupal/drupal
          ref: ${{ matrix.drupal-core }}

      - name: Checkout module
        uses: actions/checkout@v2
        with:
          path: modules/un_date

      - name: Setup PHP, with composer and extensions
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          coverage: none

      - name: Get composer cache directory
        id: composercache
        run: echo "::set-output name=dir::$(composer config cache-files-dir)"

      - name: Cache composer dependencies
        uses: actions/cache@v2
        with:
          path: ${{ steps.composercache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Drupal core dependencies
        run: |
          composer --no-interaction --no-progress --prefer-dist --optimize-autoloader install

      - name: Install module dependencies
        run: |
          composer --no-interaction --no-progress require \
            drupal/datetime_range_timezone drupal/date_recur

      - name: Install Coder module
        run: |
          composer --dev --no-interaction --no-progress require \
            drupal/coder:8.3.13 phpunit/phpunit

      - name: Define DRUPAL_ROOT env variable
        run: |
          echo "DRUPAL_ROOT=$HOME/drupal" >> $GITHUB_ENV

      - name: Check coding standards
        run: |
          ./vendor/bin/phpcs --config-set installed_paths vendor/drupal/coder/coder_sniffer
          ./vendor/bin/phpcs --standard=Drupal,DrupalPractice --extensions=php,module,install,js modules/un_date

      - name: Install drush
        run: composer require "drush/drush ^11.0"

      - name: Install PHPCS
        run: |
          composer config --no-plugins \
            allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer require --dev "drupal/coder"

      - name: Install Drupal
        run: |
          php -d sendmail_path=$(which true); vendor/bin/drush --yes -v \
            site-install minimal --db-url="$SIMPLETEST_DB"
          vendor/bin/drush en $DRUPAL_MODULE_NAME -y

      - name: Run tests
        run: |
          vendor/bin/phpunit --bootstrap core/tests/bootstrap.php \
            -c modules/un_date/phpunit.xml modules/un_date
